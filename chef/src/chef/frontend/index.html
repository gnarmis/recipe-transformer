<HTML>
	<HEAD>
        <link rel="stylesheet" type="text/css" href="style.css" />

	    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
		<script type="text/javascript">
			function MainNS(){
				var ingredients = new Array();
				var steps = new Array();
				var currentStep = -1;
				var currentTimer = null;
				var currentTimerMax = null;
				var currentTimerMaxTotal = 0;
				var currentTimerStartTimestamp = null;
				var currentTimerIntervalHandle = null;

				var testData = {"steps":[
							    {
							    	"step":"Place %INGR0% in the oven for 10 to 12 minutes",
							    	"timeString": {
								        "seconds": "5", 
								        "hours": "0", 
								        "minutes": "0"
							        }
							    },
						    	{
							    	"step":"Place %INGR1% in the oven",
							    	"timeString": {
								        "seconds": null,
								        "hours": null,
								        "minutes": null
							        }
						      	}],
								"ingredients":[
								    {
								    	"full_sentence": "5 slices bacon", 
								    	"name": "bacons", 
								    	"number": "5", 
								    	"measurement": "", 
								    	"adj": "", 
								    	"prep": "slices"
								    },
								    {
								      "full_sentence": "3 eggs", 
								      "name": "eggs", 
								      "number": "3", 
								      "measurement": "", 
								      "adj": "", 
								      "prep": ""
								    }]
								}

				var addIngredient = function(ingredient){
					ingredients.push(ingredient);
					$("#ingredients").append(
						$("<span></span>")
						.append(ingredient.full_sentence)
						.addClass("ingredient")
					)
				}

				var addStep = function(step){
					steps.push(step);
				}

				var parseJSON = function(data){
					for(var i=0;i<data.ingredients.length;i++){
						addIngredient(data.ingredients[i]);
					}
					for(var i=0;i<data.steps.length;i++){
						addStep(data.steps[i]);
					}
				}

				this.prevStep = function(){
					if(currentStep > 0){
						currentStep--;
						showTimer();
						var parsedStr = parseIngredientStr(steps[currentStep].step);
						$("#step").text(parsedStr);
					}
				}

				this.nextStep = function(){
					if(currentStep < steps.length-1){
						currentStep++;
						showTimer();
						var parsedStr = parseIngredientStr(steps[currentStep].step);
						$("#step").text(parsedStr);
					}
				}

				var showTimer = function(){
					if(steps[currentStep].timeString.seconds != null){
						currentTimerMax = steps[currentStep].timeString;
						currentTimerStartTimestamp = null;
						mainNS.updateTimer();

						$("#timer").removeClass("timerDone");
						$("#ingredients").css("bottom","50px");
						$("#step").css("bottom","50px");
						$("#timer").show();
					} else {
						$("#ingredients").css("bottom","0");
						$("#step").css("bottom","0");
						$("#timer").hide();
					}
				}

				var parseIngredientStr = function(str){
					//Find ingredient tags in string and highlight them
					//in the ingredient list.
					$("#ingredients").children().removeClass("highlighted");

					var patt = /%INGR[0-9]+%/;
					var strParsed = "";
					var strUnparsed = str;

					var matchIndex = strUnparsed.search(patt);
					while(matchIndex != -1){
						match = strUnparsed.match(patt)[0];
						ingrIndex = Number(match.substring(5,match.length-1));
						ingrName = ingredients[ingrIndex].name;
						$("#ingredients .ingredient:nth-child("+(ingrIndex+1)+")").addClass("highlighted");

						strUnparsed = strUnparsed.replace(patt,ingrName);
						strParsed += strUnparsed.substring(0,matchIndex+match.length);
						strUnparsed = strUnparsed.substring(matchIndex+match.length);

						matchIndex = strUnparsed.search(patt);
					}

					strParsed += strUnparsed;

					return strParsed;
				}

				this.onLoad = function(){
					var ingredientsStr = "asdfjaksdhfasdfads";
					var stepsStr = "asldfkasjdjfas";
					/*$.get("http://localhost:5000/RecipeParser/"+ingredients+"/"+steps+"/",
						function(data){
							//populate ingredients and steps.
							parseJSON(data);
						}
					);*/
					parseJSON(testData);
					this.nextStep();
				}

				this.startTimer = function(){
					currentTimerMaxTotal = currentTimerMax.hours * 3600000 + currentTimerMax.minutes * 60000 + currentTimerMax.seconds * 1000;
					currentTimerStartTimestamp = new Date().getTime();
					currentTimer = currentTimerMax;
					currentTimerIntervalHandle = setInterval(function(){mainNS.updateTimer()},250);
				}

				this.updateTimer = function(){
					var hours;
					var minutes;
					var seconds;

					if(currentTimerStartTimestamp != null){
						var elapsed = new Date().getTime() - currentTimerStartTimestamp;
						var remaining = currentTimerMaxTotal - elapsed;
						hours = Math.floor(remaining/3600000);
						minutes = Math.floor((remaining % 3600000)/60000);
						seconds = Math.round(((remaining % 3600000) % 60000)/1000);
					} else {
						hours = currentTimerMax.hours;
						minutes = currentTimerMax.minutes;
						seconds = currentTimerMax.seconds;
					}

					if(hours < 0 || minutes < 0 || seconds < 0){
						hours = 0;
						minutes = 0;
						seconds = 0;
						$("#timer").addClass("timerDone");
					} else if(hours == 0 && minutes == 0 && seconds == 0){
						$("#timer").addClass("timerDone");
					}

					minutes = minutes.toString();
					seconds = seconds.toString();

					if(minutes.length < 2) minutes = "0"+minutes;
					if(seconds.length < 2) seconds = "0"+seconds;

					$("#timerHours").text(hours);
					$("#timerMinutes").text(minutes);
					$("#timerSeconds").text(seconds);
				}
			}
			mainNS = new MainNS();
		</script>
	</HEAD>
	<BODY onload="mainNS.onLoad()">
		<div id="ingredients">
		</div>
		<div id="step">
		</div>
		<div id="fwdBackButtons">
			<div id="backButton" onclick="mainNS.prevStep()">&lt;
			</div>
			<div id="fwdButton" onclick="mainNS.nextStep()">&gt;
			</div>
		</div>
		<div id="timer">
			<span id="timerHours"></span>:
			<span id="timerMinutes"></span>:
			<span id="timerSeconds"></span>
			<input id="timerStartButton" type="button" value="Start" onclick="mainNS.startTimer()" />
			<div id="timerBar">
				<div id="timerBarFill"></div>
			</div>
		</div>
	</BODY>
</HTML>